name: Generate App & Run E2E Tests

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:
    inputs:
      app-type:
        description: 'Application type'
        required: true
        default: 'fullstack'
        type: choice
        options:
          - react-spa
          - fullstack
          - api-only

env:
  ORCHESTRATOR_URL: http://localhost:3000
  TEST_TIMEOUT: 300
  CI: true

jobs:
  setup:
    name: Setup Test Environment
    runs-on: ubuntu-latest
    outputs:
      app-id: ${{ steps.generate.outputs.app-id }}
      app-path: ${{ steps.generate.outputs.app-path }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.11.0'
          cache: 'npm'

      - name: Start Services (Docker Compose)
        run: |
          docker-compose -f docker-compose.yml up -d
          echo "Waiting for services to be ready..."
          sleep 15
          docker-compose ps

      - name: Wait for Orchestrator
        run: |
          for i in {1..30}; do
            if curl -f http://localhost:3000/api/v1/health; then
              echo "Orchestrator is ready"
              exit 0
            fi
            echo "Attempt $i/30: Waiting for orchestrator..."
            sleep 2
          done
          echo "Orchestrator failed to start"
          docker-compose logs orchestrator
          exit 1

      - name: Generate Application
        id: generate
        run: |
          APP_TYPE="${{ github.event.inputs.app-type || 'fullstack' }}"
          TIMESTAMP=$(date +%s)
          APP_ID="app-${TIMESTAMP}"

          echo "üì¶ Generating $APP_TYPE application..."

          curl -s -X POST http://localhost:3000/api/v1/workflows \
            -H "Content-Type: application/json" \
            -d '{
              "type": "'"$APP_TYPE"'",
              "name": "'"$APP_ID"'",
              "description": "Generated by CI/CD pipeline",
              "priority": "high",
              "requirements": "Full-stack application with React frontend and Fastify backend API"
            }' > response.json

          WORKFLOW_ID=$(jq -r '.workflow_id' response.json)
          echo "app-id=$WORKFLOW_ID" >> $GITHUB_OUTPUT
          echo "app-path=/tmp/agentic-sdlc-output/$WORKFLOW_ID" >> $GITHUB_OUTPUT

          echo "Generated app: $WORKFLOW_ID"

          # Wait for generation to complete
          for i in {1..60}; do
            STATUS=$(curl -s http://localhost:3000/api/v1/workflows/$WORKFLOW_ID | jq -r '.state')
            echo "Status: $STATUS"
            if [ "$STATUS" = "completed" ]; then
              echo "‚úÖ App generation completed"
              exit 0
            elif [ "$STATUS" = "failed" ]; then
              echo "‚ùå App generation failed"
              exit 1
            fi
            sleep 5
          done

          echo "‚ùå App generation timeout"
          exit 1

  test:
    name: Run E2E Tests
    runs-on: ubuntu-latest
    needs: setup
    strategy:
      matrix:
        node-version: [20]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}
          cache: 'npm'

      - name: Install Playwright Browsers
        run: |
          cd /tmp/hello-world-e2e-test
          npx playwright install chromium firefox webkit

      - name: Setup Generated App
        run: |
          APP_PATH="${{ needs.setup.outputs.app-path }}"
          echo "üìÅ Setting up app from: $APP_PATH"

          if [ ! -d "$APP_PATH" ]; then
            echo "‚ùå App path not found: $APP_PATH"
            exit 1
          fi

          # Copy app to test framework
          mkdir -p /tmp/hello-world-e2e-test/client
          mkdir -p /tmp/hello-world-e2e-test/server

          if [ -d "$APP_PATH/client" ]; then
            cp -r "$APP_PATH/client/"* /tmp/hello-world-e2e-test/client/ || echo "No client found"
          fi

          if [ -d "$APP_PATH/server" ]; then
            cp -r "$APP_PATH/server/"* /tmp/hello-world-e2e-test/server/ || echo "No server found"
          fi

          echo "‚úÖ App setup complete"

      - name: Install Test Dependencies
        run: |
          cd /tmp/hello-world-e2e-test
          npm install

      - name: Install App Dependencies
        run: |
          if [ -f /tmp/hello-world-e2e-test/client/package.json ]; then
            cd /tmp/hello-world-e2e-test/client
            npm install --ci || npm install
          fi

          if [ -f /tmp/hello-world-e2e-test/server/package.json ]; then
            cd /tmp/hello-world-e2e-test/server
            npm install --ci || npm install
          fi

      - name: Run All E2E Tests
        id: e2e-tests
        continue-on-error: true
        run: |
          cd /tmp/hello-world-e2e-test
          npm test -- --reporter=json --reporter=html 2>&1 | tee test-output.log
          TEST_EXIT=${PIPESTATUS[0]}
          echo "test-status=$TEST_EXIT" >> $GITHUB_OUTPUT
          exit $TEST_EXIT

      - name: Generate Test Summary
        if: always()
        run: |
          cd /tmp/hello-world-e2e-test

          if [ -f playwright/reports/results.json ]; then
            echo "### E2E Test Results" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY

            TOTAL=$(jq '.stats.tests' playwright/reports/results.json)
            PASSED=$(jq '.stats.passes' playwright/reports/results.json)
            FAILED=$(jq '.stats.failures' playwright/reports/results.json)
            DURATION=$(jq '.stats.duration' playwright/reports/results.json)

            echo "| Metric | Value |" >> $GITHUB_STEP_SUMMARY
            echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
            echo "| Total Tests | $TOTAL |" >> $GITHUB_STEP_SUMMARY
            echo "| Passed | $PASSED ‚úÖ |" >> $GITHUB_STEP_SUMMARY
            echo "| Failed | $FAILED ‚ùå |" >> $GITHUB_STEP_SUMMARY
            echo "| Duration | $(echo "scale=2; $DURATION / 1000" | bc)s |" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Upload Test Reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: e2e-test-reports
          path: /tmp/hello-world-e2e-test/playwright/reports/
          retention-days: 30

      - name: Check Test Status
        run: |
          TEST_STATUS="${{ steps.e2e-tests.outputs.test-status }}"
          if [ "$TEST_STATUS" != "0" ]; then
            echo "‚ùå Tests failed with status: $TEST_STATUS"
            exit 1
          fi
          echo "‚úÖ All E2E tests passed!"

  cleanup:
    name: Cleanup
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: Shutdown Services
        run: |
          docker-compose down -v || true
          echo "‚úÖ Services cleaned up"

      - name: Cleanup Artifacts
        run: |
          rm -rf /tmp/agentic-sdlc-output/* || true
          rm -rf /tmp/hello-world-e2e-test/client || true
          rm -rf /tmp/hello-world-e2e-test/server || true
          echo "‚úÖ Artifacts cleaned up"
