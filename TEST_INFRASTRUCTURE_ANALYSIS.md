# Test Infrastructure Analysis - AgentEnvelope v2.0.0

**Generated by:** @test-generator
**Date:** 2025-11-14
**Purpose:** EXPLORATION ONLY - Document existing test patterns and identify infrastructure needs

---

## Executive Summary

**Status:** Test infrastructure exists but AgentEnvelope v2.0.0 has ZERO test coverage
**Critical Gap:** No tests use AgentEnvelope schema (introduced Session #65)
**Test Pattern:** Vitest + describe/it + factory fixtures + mocks
**Priority:** Create AgentEnvelope fixtures FIRST, then unit tests, then integration tests

---

## 1. Existing Test Patterns

### 1.1 Test Framework: Vitest

**Configuration:** `vitest.config.ts` in each package
```typescript
{
  test: {
    globals: true,
    environment: 'node',
    testTimeout: 10000,
    coverage: { thresholds: { lines: 90 } }
  }
}
```

**Pattern:** describe/it blocks (BDD-style)
```typescript
describe('ComponentName', () => {
  beforeEach(() => { /* setup */ });
  afterEach(() => { /* cleanup */ });

  it('should do something', async () => {
    expect(result).toBe(expected);
  });
});
```

**Location:** Tests live in:
- `tests/` directory (base-agent, scaffold-agent)
- `src/__tests__/` directory (deployment-agent, integration-agent, validation-agent)
- `e2e/` directory (dashboard - Playwright)

---

### 1.2 Mock Pattern: Vitest vi.mock()

**Example from base-agent.test.ts:1-27**
```typescript
// Mock modules BEFORE imports
vi.mock('ioredis', async () => {
  const RedisMock = (await import('ioredis-mock')).default;
  return { default: RedisMock };
});

vi.mock('@anthropic-ai/sdk');

vi.mock('@agentic-sdlc/shared-utils', () => ({
  retry: async <T>(fn: () => Promise<T>) => fn(),
  RetryPresets: { standard: { maxAttempts: 3, delayMs: 1000 } },
  CircuitBreaker: vi.fn(() => ({ execute: vi.fn(async (fn: any) => fn()) }))
}));

// THEN import after mocks
import { BaseAgent } from '../src/base-agent';
```

**Key Pattern:**
1. Mock external dependencies FIRST
2. Then import production code
3. Use vi.fn() for spy functions
4. Mock return values with mockResolvedValue() / mockReturnValue()

---

### 1.3 Fixture Pattern: Factory Functions

**Example: ScaffoldFactory** (`packages/shared/test-utils/src/factories/scaffold.factory.ts`)

```typescript
export const ScaffoldFactory = {
  task: (overrides: Partial<ScaffoldTask> = {}): ScaffoldTask => {
    return {
      task_id: toTaskId(`task_test_${Date.now()}`),
      workflow_id: toWorkflowId(`wf_test_${Date.now()}`),
      agent_type: 'scaffold',
      action: 'generate_structure',
      status: 'pending',
      priority: 50,
      payload: { /* default payload */ },
      version: VERSION,
      timeout_ms: 120000,
      retry_count: 0,
      max_retries: 3,
      created_at: new Date().toISOString(),
      ...overrides  // ✅ Override pattern
    };
  },

  result: (overrides: Partial<ScaffoldResult> = {}): ScaffoldResult => {
    // Default successful result
  },

  failedResult: (error: string): ScaffoldResult => {
    // Pre-configured failure result
  },

  minimalTask: (): ScaffoldTask => {
    // Only required fields
  },

  complexAppTask: (): ScaffoldTask => {
    // Real-world complex scenario
  }
};
```

**Usage in tests:**
```typescript
const task = ScaffoldFactory.task({
  workflow_id: 'my-workflow-123',
  priority: 100
});
```

**Pattern Benefits:**
- DRY: One source of truth for test data
- Type-safe: Returns proper TypeScript types
- Flexible: Override any field via partial object
- Scenarios: Pre-built complex/minimal/failure cases

---

### 1.4 Test Setup Utilities

**Location:** `packages/shared/test-utils/src/setup/test-setup.ts`

**Utilities Available:**

1. **setupAgentTests()** - Automated lifecycle hooks
```typescript
export function setupAgentTests(options: SetupOptions = {}): TestContext {
  // Auto-setup: beforeAll, beforeEach, afterEach, afterAll
  // Returns: { redis, anthropic, cleanup }
}
```

2. **withTestContext()** - Error boundary with guaranteed cleanup
```typescript
await withTestContext(async (ctx) => {
  // Test code here
  // Cleanup guaranteed even if test throws
}, { mockRedis: true });
```

3. **waitFor()** - Async condition waiter
```typescript
await waitFor(() => agent.isReady(), {
  timeout: 5000,
  interval: 100,
  message: 'Agent never became ready'
});
```

4. **flushPromises()** - Promise queue flusher
```typescript
await flushPromises(); // Wait for all pending promises
```

5. **createTestLogger()** - Capturable logger
```typescript
const logger = createTestLogger();
agent.setLogger(logger);
expect(logger.hasLog('info', 'Task received')).toBe(true);
```

6. **mockEnvironment()** - Env var mocking
```typescript
const restore = mockEnvironment({
  REDIS_HOST: 'test-redis'
});
// ... test ...
restore(); // Restore original env
```

---

### 1.5 Mock Implementations

**Location:** `packages/shared/test-utils/src/mocks/`

**RedisMock** (`redis.mock.ts`):
```typescript
export interface RedisMock {
  subscribe: any;
  publish: any;
  // ... Redis API methods ...

  // Test helpers
  simulateMessage: (channel: string, message: string) => void;
  getPublishedMessages: () => Array<{ channel: string; message: string }>;
  clearAll: () => void;
}

export function createRedisMock(): RedisMock {
  // Full Redis API mock with tracking
}
```

**AnthropicMock** (`anthropic.mock.ts`):
```typescript
export interface AnthropicMock {
  messages: { create: any };
  setResponse: (response: string) => void;
  setError: (error: Error) => void;
  reset: () => void;
}

export function createAnthropicMock(options?: AnthropicMockOptions): AnthropicMock {
  // Claude API mock
}
```

**Usage:**
```typescript
import { createRedisMock, createAnthropicMock } from '@agentic-sdlc/test-utils';

const redis = createRedisMock();
await redis.publish('test-channel', JSON.stringify(task));
const published = redis.getPublishedMessages();
expect(published).toHaveLength(1);
```

---

## 2. Current Test Coverage by Package

### 2.1 Agent Tests

**base-agent** (`tests/base-agent.test.ts` - 256 lines)
- ✅ Initialization
- ✅ Task validation
- ✅ Task execution
- ✅ Result reporting
- ✅ Health check
- ✅ Retry logic
- ✅ Claude integration
- ✅ Cleanup
- **Schema:** Uses OLD `TaskAssignment` type (NOT AgentEnvelope)

**scaffold-agent** (`tests/scaffold-agent.test.ts` - 472 lines)
- ✅ Agent initialization
- ✅ Task execution (success/failure)
- ✅ Claude API error handling
- ✅ Project type support (service/app/feature/capability)
- ✅ Contract generation
- ✅ Test generation
- ✅ Metrics collection
- **Schema:** Uses OLD `TaskAssignment` type (NOT AgentEnvelope)

**validation-agent** (`src/__tests__/validation-agent.test.ts` - 220 lines)
- ✅ Constructor
- ✅ Execute validation task
- ✅ Validator type filtering
- ✅ Failure/warning handling
- ✅ Custom thresholds
- **Schema:** Uses OLD `ValidationTask` type (NOT AgentEnvelope)

**deployment-agent** (`src/__tests__/deployment-agent.test.ts`)
- ✅ Basic deployment tests
- **Schema:** OLD type (NOT AgentEnvelope)

**integration-agent** (`src/__tests__/integration-agent.test.ts`)
- ✅ Basic integration tests
- **Schema:** OLD type (NOT AgentEnvelope)

### 2.2 Orchestrator Tests

**workflow.service.test.ts** - Mock-based unit tests
```typescript
// Mocks repository, event bus, state machine
const mockRepository = { create: vi.fn(), findById: vi.fn() };
const mockEventBus = { publish: vi.fn() };
const service = new WorkflowService(mockRepository, mockEventBus);
```

**E2E tests** (`tests/e2e/` directory)
- `scaffold-happy-path.test.ts` - Uses ScaffoldFactory
- `three-agent-pipeline.test.ts`
- `five-agent-pipeline.test.ts`
- `full-workflow.test.ts`
- **Schema:** Uses OLD task types (NOT AgentEnvelope)

### 2.3 Dashboard Tests

**Playwright E2E** (`packages/dashboard/e2e/*.spec.ts`)
- ✅ Dashboard overview page
- ✅ Workflows page
- ✅ Navigation
- **Status:** 8/11 passing (3 timing issues)

---

## 3. Missing Test Infrastructure for AgentEnvelope v2.0.0

### 3.1 CRITICAL GAP: No AgentEnvelope Fixtures

**Issue:** AgentEnvelope v2.0.0 introduced in Session #65, but:
- ❌ No factory functions exist
- ❌ No test fixtures in test-utils
- ❌ Zero tests use AgentEnvelope schema
- ❌ All existing tests use OLD schemas (TaskAssignment, ValidationTask, etc.)

**Impact:** Cannot write tests for:
- BaseAgent.validateTask() (validates AgentEnvelope)
- BaseAgent.execute() (receives AgentEnvelope)
- All 5 agent implementations
- Orchestrator buildAgentEnvelope() function
- Message bus envelope validation

### 3.2 Missing Factory: AgentEnvelopeFactory

**Needed:** `packages/shared/test-utils/src/factories/agent-envelope.factory.ts`

**Required Methods:**
```typescript
export const AgentEnvelopeFactory = {
  // Basic envelope with defaults
  envelope: (overrides?: Partial<AgentEnvelope>): AgentEnvelope => {},

  // Agent-specific envelopes
  scaffoldEnvelope: (overrides?: Partial<AgentEnvelope>): AgentEnvelope => {},
  validationEnvelope: (overrides?: Partial<AgentEnvelope>): AgentEnvelope => {},
  e2eEnvelope: (overrides?: Partial<AgentEnvelope>): AgentEnvelope => {},
  integrationEnvelope: (overrides?: Partial<AgentEnvelope>): AgentEnvelope => {},
  deploymentEnvelope: (overrides?: Partial<AgentEnvelope>): AgentEnvelope => {},

  // Scenarios
  minimalEnvelope: (): AgentEnvelope => {},        // Only required fields
  complexEnvelope: (): AgentEnvelope => {},        // Real-world example
  invalidEnvelope: (): any => {},                  // For validation failure tests

  // Trace variations
  rootSpanEnvelope: (): AgentEnvelope => {},       // No parent_span_id
  childSpanEnvelope: (parent: string): AgentEnvelope => {},

  // Priority variations
  lowPriorityEnvelope: (): AgentEnvelope => {},
  criticalPriorityEnvelope: (): AgentEnvelope => {}
};
```

### 3.3 Missing Helper: createAgentEnvelopeBuilder()

**Purpose:** Fluent API for building test envelopes

```typescript
export function createAgentEnvelopeBuilder() {
  return {
    forAgent: (type: AgentType) => this,
    withWorkflow: (id: string) => this,
    withTask: (id: string) => this,
    withPayload: (payload: Record<string, unknown>) => this,
    withTrace: (traceId: string, spanId: string, parentSpanId?: string) => this,
    withPriority: (priority: Priority) => this,
    withConstraints: (constraints: Partial<ExecutionConstraints>) => this,
    build: (): AgentEnvelope => {}
  };
}

// Usage:
const envelope = createAgentEnvelopeBuilder()
  .forAgent('scaffold')
  .withWorkflow('wf-123')
  .withPayload({ project_type: 'app' })
  .withTrace('trace-abc', 'span-001')
  .build();
```

### 3.4 Missing Validators: Schema Assertion Helpers

**Needed:** `packages/shared/test-utils/src/assertions/schema-assertions.ts`

```typescript
export function assertValidAgentEnvelope(data: unknown): asserts data is AgentEnvelope {
  const result = AgentEnvelopeSchema.safeParse(data);
  if (!result.success) {
    throw new Error(`Invalid AgentEnvelope: ${JSON.stringify(result.error.errors)}`);
  }
}

export function assertEnvelopeMatches(
  actual: AgentEnvelope,
  expected: Partial<AgentEnvelope>
): void {
  Object.entries(expected).forEach(([key, value]) => {
    expect(actual[key]).toEqual(value);
  });
}

export function assertTraceContext(envelope: AgentEnvelope): void {
  expect(envelope.trace.trace_id).toBeDefined();
  expect(envelope.trace.span_id).toMatch(/^[0-9a-f]{16}$/);
}
```

### 3.5 Missing Mock: MessageBusMock

**Current:** RedisMock exists but not MessageBusMock for IMessageBus interface

**Needed:** `packages/shared/test-utils/src/mocks/message-bus.mock.ts`

```typescript
export interface MessageBusMock extends IMessageBus {
  getPublishedEnvelopes: () => AgentEnvelope[];
  simulateIncomingEnvelope: (envelope: AgentEnvelope) => void;
  clearHistory: () => void;
}

export function createMessageBusMock(): MessageBusMock {
  const published: AgentEnvelope[] = [];

  return {
    publish: vi.fn(async (channel: string, envelope: AgentEnvelope) => {
      published.push(envelope);
    }),
    subscribe: vi.fn(async (channel: string, handler: (env: AgentEnvelope) => void) => {
      // Register handler
    }),
    getPublishedEnvelopes: () => [...published],
    // ...
  };
}
```

---

## 4. AgentEnvelope Test Template

### 4.1 Unit Test Template

**File:** `packages/agents/base-agent/tests/agent-envelope.test.ts` (NEW)

```typescript
import { describe, it, expect, beforeEach, vi } from 'vitest';
import { BaseAgent } from '../src/base-agent';
import { AgentEnvelope, AgentEnvelopeSchema } from '@agentic-sdlc/shared-types';
import { AgentEnvelopeFactory } from '@agentic-sdlc/test-utils';

describe('BaseAgent - AgentEnvelope v2.0.0', () => {
  let agent: TestAgent;

  beforeEach(() => {
    agent = new TestAgent();
  });

  describe('validateTask()', () => {
    it('should validate valid AgentEnvelope', () => {
      const envelope = AgentEnvelopeFactory.scaffoldEnvelope();

      const validated = agent.validateTask(envelope);

      expect(validated).toEqual(envelope);
      expect(validated.metadata.envelope_version).toBe('2.0.0');
    });

    it('should reject envelope with missing message_id', () => {
      const invalid = AgentEnvelopeFactory.invalidEnvelope({
        message_id: undefined
      });

      expect(() => agent.validateTask(invalid))
        .toThrow('Invalid task assignment - must conform to AgentEnvelope v2.0.0');
    });

    it('should reject envelope with invalid priority', () => {
      const invalid = {
        ...AgentEnvelopeFactory.scaffoldEnvelope(),
        priority: 'super-high' // Invalid enum value
      };

      expect(() => agent.validateTask(invalid))
        .toThrow('Invalid task assignment');
    });

    it('should validate nested trace context', () => {
      const envelope = AgentEnvelopeFactory.childSpanEnvelope('parent-span-123');

      const validated = agent.validateTask(envelope);

      expect(validated.trace.parent_span_id).toBe('parent-span-123');
      expect(validated.trace.trace_id).toBeDefined();
      expect(validated.trace.span_id).toMatch(/^[0-9a-f]{16}$/);
    });

    it('should validate nested constraints', () => {
      const envelope = AgentEnvelopeFactory.envelope({
        constraints: {
          timeout_ms: 60000,
          max_retries: 5,
          required_confidence: 90
        }
      });

      const validated = agent.validateTask(envelope);

      expect(validated.constraints.timeout_ms).toBe(60000);
      expect(validated.constraints.max_retries).toBe(5);
    });
  });

  describe('execute()', () => {
    it('should execute task with AgentEnvelope format', async () => {
      const envelope = AgentEnvelopeFactory.scaffoldEnvelope({
        payload: {
          project_type: 'app',
          name: 'test-app'
        }
      });

      const result = await agent.execute(envelope);

      expect(result.task_id).toBe(envelope.task_id);
      expect(result.workflow_id).toBe(envelope.workflow_id);
      expect(result.status).toBe('success');
    });

    it('should access payload from envelope', async () => {
      const envelope = AgentEnvelopeFactory.scaffoldEnvelope({
        payload: {
          custom_field: 'test-value'
        }
      });

      const result = await agent.execute(envelope);

      // Agent should have accessed envelope.payload.custom_field
      expect(result.output).toHaveProperty('custom_field', 'test-value');
    });

    it('should propagate trace context', async () => {
      const envelope = AgentEnvelopeFactory.envelope({
        trace: {
          trace_id: 'trace-123',
          span_id: 'span-456',
          parent_span_id: 'parent-789'
        }
      });

      const result = await agent.execute(envelope);

      // Result should include trace context
      expect(result.trace_id).toBe('trace-123');
    });
  });

  describe('Envelope Schema Compliance', () => {
    it('should match exact schema structure from buildAgentEnvelope()', () => {
      const envelope = AgentEnvelopeFactory.scaffoldEnvelope();

      // Validate against canonical schema
      const result = AgentEnvelopeSchema.safeParse(envelope);

      expect(result.success).toBe(true);
    });

    it('should have all required nested objects', () => {
      const envelope = AgentEnvelopeFactory.scaffoldEnvelope();

      expect(envelope.constraints).toBeDefined();
      expect(envelope.metadata).toBeDefined();
      expect(envelope.trace).toBeDefined();
      expect(envelope.workflow_context).toBeDefined();
    });

    it('should have envelope_version 2.0.0 in metadata', () => {
      const envelope = AgentEnvelopeFactory.scaffoldEnvelope();

      expect(envelope.metadata.envelope_version).toBe('2.0.0');
    });
  });
});
```

### 4.2 Integration Test Template

**File:** `packages/agents/scaffold-agent/tests/scaffold-envelope-integration.test.ts` (NEW)

```typescript
import { describe, it, expect, beforeEach, vi } from 'vitest';
import { ScaffoldAgent } from '../src/scaffold-agent';
import { AgentEnvelopeFactory, createMessageBusMock } from '@agentic-sdlc/test-utils';
import { AgentEnvelope } from '@agentic-sdlc/shared-types';

describe('ScaffoldAgent - AgentEnvelope Integration', () => {
  let agent: ScaffoldAgent;
  let messageBus: ReturnType<typeof createMessageBusMock>;

  beforeEach(async () => {
    messageBus = createMessageBusMock();
    agent = new ScaffoldAgent();
    await agent.initialize();
  });

  it('should receive AgentEnvelope via message bus', async () => {
    const envelope = AgentEnvelopeFactory.scaffoldEnvelope({
      payload: {
        project_type: 'app',
        name: 'integration-test-app',
        description: 'Test',
        requirements: ['Auth'],
        tech_stack: {
          language: 'typescript',
          runtime: 'node',
          testing: 'vitest',
          package_manager: 'pnpm'
        }
      }
    });

    // Simulate message bus delivery
    messageBus.simulateIncomingEnvelope(envelope);

    // Wait for agent to process
    await waitFor(() => messageBus.getPublishedEnvelopes().length > 0);

    // Verify result was published
    const published = messageBus.getPublishedEnvelopes();
    expect(published).toHaveLength(1);
    expect(published[0].task_id).toBe(envelope.task_id);
  });

  it('should handle all 5 agent types', async () => {
    const agentTypes: AgentType[] = [
      'scaffold', 'validation', 'e2e_test', 'integration', 'deployment'
    ];

    for (const type of agentTypes) {
      const envelope = AgentEnvelopeFactory.envelope({
        agent_type: type,
        payload: { test: true }
      });

      const result = AgentEnvelopeSchema.safeParse(envelope);
      expect(result.success).toBe(true);
    }
  });
});
```

---

## 5. Test Creation Priority Order

### Phase 1: Foundation (IMMEDIATE - 2-3 hours)
1. **Create AgentEnvelopeFactory** - Top priority
   - File: `packages/shared/test-utils/src/factories/agent-envelope.factory.ts`
   - Methods: envelope(), scaffoldEnvelope(), validationEnvelope(), e2eEnvelope(), integrationEnvelope(), deploymentEnvelope()
   - Export from test-utils index.ts

2. **Create Schema Assertions**
   - File: `packages/shared/test-utils/src/assertions/schema-assertions.ts`
   - Functions: assertValidAgentEnvelope(), assertEnvelopeMatches(), assertTraceContext()

3. **Update test-utils exports**
   - Add to `packages/shared/test-utils/src/index.ts`

### Phase 2: Unit Tests (HIGH PRIORITY - 4-5 hours)
4. **base-agent AgentEnvelope tests**
   - File: `packages/agents/base-agent/tests/agent-envelope.test.ts` (NEW)
   - Test validateTask() with AgentEnvelope v2.0.0
   - Test execute() signature change
   - Test schema compliance

5. **scaffold-agent AgentEnvelope tests**
   - File: `packages/agents/scaffold-agent/tests/scaffold-envelope.test.ts` (NEW)
   - Test payload access via envelope.payload
   - Test trace propagation
   - Test constraints handling

6. **Repeat for other 4 agents**
   - validation-agent
   - e2e-agent
   - integration-agent
   - deployment-agent

### Phase 3: Integration Tests (MEDIUM PRIORITY - 3-4 hours)
7. **Message Bus Integration**
   - Create MessageBusMock
   - Test envelope publishing/receiving
   - Test schema validation in message flow

8. **Orchestrator Integration**
   - Test buildAgentEnvelope() output
   - Validate against AgentEnvelopeSchema
   - Test workflow.service.ts task dispatch

### Phase 4: E2E Tests (LOW PRIORITY - 5-6 hours)
9. **Update existing E2E tests**
   - Replace old task types with AgentEnvelope
   - Update ScaffoldFactory usage
   - Add envelope validation checks

10. **Create new AgentEnvelope E2E tests**
    - Full workflow with AgentEnvelope v2.0.0
    - Multi-agent pipeline
    - Trace propagation end-to-end

---

## 6. Recommended Test Utilities to Add

### 6.1 Envelope Builder (Fluent API)
```typescript
// packages/shared/test-utils/src/builders/envelope-builder.ts
export class EnvelopeBuilder {
  private envelope: Partial<AgentEnvelope> = {};

  forAgent(type: AgentType): this { /* ... */ }
  withWorkflow(id: string): this { /* ... */ }
  withTrace(traceId: string, spanId: string, parentSpanId?: string): this { /* ... */ }

  build(): AgentEnvelope { /* ... */ }
}
```

### 6.2 Envelope Matcher (Custom Vitest Matcher)
```typescript
// packages/shared/test-utils/src/matchers/envelope-matchers.ts
expect.extend({
  toBeValidAgentEnvelope(received: unknown) {
    const result = AgentEnvelopeSchema.safeParse(received);
    return {
      pass: result.success,
      message: () => `Expected valid AgentEnvelope, got: ${JSON.stringify(result.error)}`
    };
  }
});

// Usage:
expect(envelope).toBeValidAgentEnvelope();
```

### 6.3 Envelope Snapshot Testing
```typescript
// Test that envelope structure matches snapshot
it('should match envelope snapshot', () => {
  const envelope = AgentEnvelopeFactory.scaffoldEnvelope();
  expect(envelope).toMatchSnapshot();
});
```

---

## 7. Coverage Gaps (After AgentEnvelope Tests Added)

### 7.1 Still Missing Tests For:
- ❌ Orchestrator workflow-state-machine.ts (complex state transitions)
- ❌ Message bus idempotency (message_id deduplication)
- ❌ Trace context propagation through full pipeline
- ❌ Constraint validation (timeout_ms, max_retries, required_confidence)
- ❌ Workflow context stage output passing
- ❌ Error scenarios (malformed envelopes, missing fields)
- ❌ Performance tests (large payloads, high message volume)

### 7.2 E2E Test Status
- ⚠️ Dashboard E2E: 8/11 passing (3 timing issues)
- ⚠️ e2e-agent tests: Removed in Session #65 (need AgentEnvelope fixtures)
- ⚠️ Pipeline tests: Need updating to use AgentEnvelope v2.0.0

---

## 8. Test Infrastructure Strengths

### What Works Well:
1. ✅ **Vitest setup** - Fast, modern, well-configured
2. ✅ **Mock implementations** - RedisMock and AnthropicMock are comprehensive
3. ✅ **Test utilities** - Good helpers (waitFor, flushPromises, etc.)
4. ✅ **Factory pattern** - ScaffoldFactory is excellent template
5. ✅ **Type safety** - All tests use TypeScript
6. ✅ **Coverage thresholds** - 90% lines, 90% functions, 85% branches
7. ✅ **Test organization** - Clear separation (unit/integration/e2e)

### Areas for Improvement:
1. ⚠️ **Schema alignment** - All existing tests use OLD schemas
2. ⚠️ **Factory gaps** - No AgentEnvelope factory (CRITICAL)
3. ⚠️ **E2E coverage** - e2e-agent tests removed, need restoration
4. ⚠️ **Message bus mocks** - Need IMessageBus mock (not just Redis)
5. ⚠️ **Assertion helpers** - Need schema-specific assertions

---

## 9. Execution Plan Summary

### Immediate Next Steps:
1. **Create AgentEnvelopeFactory** (MUST DO FIRST)
   - Location: `packages/shared/test-utils/src/factories/agent-envelope.factory.ts`
   - Pattern: Copy ScaffoldFactory structure
   - Methods: envelope(), agent-specific variants, scenarios
   - Export from test-utils

2. **Create Schema Assertions**
   - Location: `packages/shared/test-utils/src/assertions/schema-assertions.ts`
   - Functions: assertValidAgentEnvelope(), assertEnvelopeMatches()

3. **Write Base Unit Tests**
   - File: `packages/agents/base-agent/tests/agent-envelope.test.ts`
   - Test validateTask() and execute() with AgentEnvelope

4. **Propagate to All Agents**
   - Repeat unit tests for all 5 agents
   - Update existing tests to use AgentEnvelope

5. **Integration Tests**
   - Message bus integration
   - Orchestrator integration

6. **E2E Tests**
   - Restore e2e-agent tests
   - Update pipeline E2E tests

### Time Estimates:
- **Phase 1 (Foundation):** 2-3 hours
- **Phase 2 (Unit Tests):** 4-5 hours
- **Phase 3 (Integration):** 3-4 hours
- **Phase 4 (E2E):** 5-6 hours
- **Total:** 14-18 hours

---

## 10. Key Takeaways

### Current State:
- ✅ Test infrastructure EXISTS and is GOOD
- ✅ Patterns are CONSISTENT (Vitest + factories + mocks)
- ❌ AgentEnvelope v2.0.0 has ZERO test coverage
- ❌ All existing tests use OLD schemas

### Critical Path:
1. AgentEnvelopeFactory (BLOCKER for all other tests)
2. Base-agent unit tests (validates new schema)
3. Agent-specific unit tests (all 5 agents)
4. Integration tests (message bus + orchestrator)
5. E2E tests (full pipeline validation)

### Success Criteria:
- ✅ AgentEnvelopeFactory exists and works
- ✅ All agents have unit tests using AgentEnvelope
- ✅ buildAgentEnvelope() output matches AgentEnvelopeSchema
- ✅ validateTask() enforces AgentEnvelope v2.0.0
- ✅ Full pipeline E2E test passes with AgentEnvelope

---

## Appendix: File References

### Test Files Analyzed:
- `/packages/agents/base-agent/tests/base-agent.test.ts`
- `/packages/agents/scaffold-agent/tests/scaffold-agent.test.ts`
- `/packages/agents/validation-agent/src/__tests__/validation-agent.test.ts`
- `/packages/orchestrator/tests/e2e/scaffold-happy-path.test.ts`
- `/packages/orchestrator/tests/services/workflow.service.test.ts`
- `/packages/dashboard/e2e/dashboard.spec.ts`

### Test Utilities:
- `/packages/shared/test-utils/src/index.ts`
- `/packages/shared/test-utils/src/setup/test-setup.ts`
- `/packages/shared/test-utils/src/factories/scaffold.factory.ts`
- `/packages/shared/test-utils/src/mocks/redis.mock.ts`
- `/packages/shared/test-utils/src/mocks/anthropic.mock.ts`

### Schemas:
- `/packages/shared/types/src/messages/agent-envelope.ts` (v2.0.0)

### Test Configuration:
- `/packages/agents/base-agent/vitest.config.ts`

---

**End of Analysis**
