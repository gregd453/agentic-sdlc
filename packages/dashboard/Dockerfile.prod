# ==========================================
# Production Dockerfile for Dashboard
# Single-stage build with all dependencies
# ==========================================

FROM node:20.11.0-alpine

WORKDIR /app

# Install pnpm
RUN npm install -g pnpm

# Copy workspace configuration
COPY package.json pnpm-lock.yaml pnpm-workspace.yaml ./

# Copy all source code
COPY . .

# Install all dependencies (build + runtime)
RUN pnpm install

# Set build environment variables
ENV VITE_DASHBOARD_PORT=3050
ENV VITE_ORCHESTRATOR_PORT=3051

# Build everything (prebuild hooks handle Prisma generation)
RUN pnpm build

# Remove dev dependencies to keep image smaller
RUN pnpm prune --prod

# Expose port
EXPOSE 3050

# Environment
ENV NODE_ENV=production
ENV PORT=3050

# Health check
HEALTHCHECK --interval=10s --timeout=5s --retries=3 --start-period=15s \
  CMD wget --quiet --tries=1 --spider http://localhost:3050/ || exit 1

# Start Express server
CMD ["node", "packages/dashboard/dist/server/index.js"]
